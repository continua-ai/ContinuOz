generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}
model Workspace {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members   WorkspaceMember[]
  invites   WorkspaceInvite[]
  rooms     Room[]
  agents    Agent[]
  settings  Setting[]
}

model WorkspaceMember {
  id             String        @id @default(cuid())
  workspaceId    String
  userId         String
  role           WorkspaceRole @default(MEMBER)
  invitedByUserId String?
  createdAt      DateTime      @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user      User      @relation("WorkspaceMemberUser", fields: [userId], references: [id], onDelete: Cascade)
  invitedBy User?     @relation("WorkspaceMemberInviter", fields: [invitedByUserId], references: [id], onDelete: SetNull)

  @@unique([workspaceId, userId])
  @@index([userId])
}

model WorkspaceInvite {
  id              String        @id @default(cuid())
  workspaceId     String
  createdByUserId String
  role            WorkspaceRole @default(MEMBER)
  createdAt       DateTime      @default(now())
  acceptedAt      DateTime?
  expiresAt       DateTime?

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  createdBy User     @relation("WorkspaceInviteCreator", fields: [createdByUserId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([createdByUserId])
}

enum WorkspaceRole {
  OWNER
  MEMBER
}

datasource db {
  provider = "postgresql"
}

model User {
  id           String   @id @default(cuid())
  name         String
  email        String   @unique
  passwordHash String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  rooms         Room[]
  agents        Agent[]
  messages      Message[]
  artifacts     Artifact[]
  notifications Notification[]
  tasks         Task[]
  workspaceMemberships WorkspaceMember[] @relation("WorkspaceMemberUser")
  invitedWorkspaceMembers WorkspaceMember[] @relation("WorkspaceMemberInviter")
  createdInvites       WorkspaceInvite[] @relation("WorkspaceInviteCreator")
}

model Room {
  id          String   @id @default(cuid())
  name        String
  description String   @default("")
  paused      Boolean  @default(false)
  workspaceId String?
  userId      String?
  publicShareId       String?  @unique
  publicShareEnabledAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  workspace     Workspace?      @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  user          User?          @relation(fields: [userId], references: [id], onDelete: Cascade)
  agents        RoomAgent[]
  messages      Message[]
  artifacts     Artifact[]
  notifications Notification[]
  tasks         Task[]
  orchestrations AgentOrchestration[]

  @@index([workspaceId])
}

model Agent {
  id            String   @id @default(cuid())
  name          String
  color         String   @default("#3B82F6")
  icon          String   @default("robot")
  repoUrl       String   @default("")
  harness       String   @default("claude-code")
  environmentId String   @default("")
  systemPrompt  String   @default("")
  skills        String   @default("[]")
  mcpServers    String   @default("[]")
  scripts       String   @default("[]")
  status        String   @default("idle")
  activeRoomId  String?  
  workspaceId   String?
  userId        String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  workspace     Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  user          User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  rooms         RoomAgent[]
  messages      Message[]
  artifacts     Artifact[]
  notifications Notification[]
  assignedTasks Task[]   @relation("TaskAssignee")
  createdTasks  Task[]   @relation("TaskCreator")
  ledOrchestrations AgentOrchestration[]
  orchestrationChildren AgentOrchestrationChild[]

  @@index([workspaceId])
}

model RoomAgent {
  id      String @id @default(cuid())
  roomId  String
  agentId String

  room  Room  @relation(fields: [roomId], references: [id], onDelete: Cascade)
  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@unique([roomId, agentId])
}

model Message {
  id         String   @id @default(cuid())
  roomId     String
  authorId   String?
  authorType String   @default("human")
  content    String
  sessionUrl String?
  userId     String?
  timestamp  DateTime @default(now())

  room  Room   @relation(fields: [roomId], references: [id], onDelete: Cascade)
  agent Agent? @relation(fields: [authorId], references: [id], onDelete: SetNull)
  user  User?  @relation(fields: [userId], references: [id], onDelete: SetNull)
}

model Artifact {
  id        String   @id @default(cuid())
  roomId    String
  type      String
  title     String
  content   String   @default("")
  url       String?
  createdBy String?
  userId    String?
  createdAt DateTime @default(now())

  room  Room   @relation(fields: [roomId], references: [id], onDelete: Cascade)
  agent Agent? @relation(fields: [createdBy], references: [id], onDelete: SetNull)
  user  User?  @relation(fields: [userId], references: [id], onDelete: SetNull)
}

model Notification {
  id        String   @id @default(cuid())
  roomId    String
  agentId   String
  message   String
  read      Boolean  @default(false)
  userId    String?
  timestamp DateTime @default(now())

  room  Room  @relation(fields: [roomId], references: [id], onDelete: Cascade)
  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)
  user  User? @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Task {
  id          String   @id @default(cuid())
  roomId      String
  title       String
  description String   @default("")
  status      String   @default("backlog")
  priority    String   @default("medium")
  assigneeId  String?
  createdBy   String?
  userId      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  room     Room   @relation(fields: [roomId], references: [id], onDelete: Cascade)
  assignee Agent? @relation("TaskAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)
  creator  Agent? @relation("TaskCreator", fields: [createdBy], references: [id], onDelete: SetNull)
  user     User?  @relation(fields: [userId], references: [id], onDelete: Cascade)
}
model AgentOrchestration {
  id            String   @id @default(cuid())
  roomId        String
  leadAgentId   String
  leadRunId     String   @unique
  status        String   @default("running")
  deadlineAt    DateTime?
  followupRunId String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  room      Room                      @relation(fields: [roomId], references: [id], onDelete: Cascade)
  leadAgent Agent                     @relation(fields: [leadAgentId], references: [id], onDelete: Cascade)
  children  AgentOrchestrationChild[]
}

model AgentOrchestrationChild {
  id              String   @id @default(cuid())
  orchestrationId String
  agentId         String
  runId           String   @unique
  status          String   @default("dispatched")
  completedAt     DateTime?
  createdAt       DateTime @default(now())

  orchestration AgentOrchestration @relation(fields: [orchestrationId], references: [id], onDelete: Cascade)
  agent         Agent             @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@unique([orchestrationId, agentId])
  @@index([orchestrationId])
}

model AgentCallback {
  id        String   @id
  response  String
  createdAt DateTime @default(now())
}

model Setting {
  id     String @id @default(cuid())
  key    String
  value  String
  workspaceId String?
  legacyUserId String? @map("userId")
  workspace Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, key])
}
